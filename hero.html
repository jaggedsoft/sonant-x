<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="example-songs/4k-synth.js"></script>
    <script src="sonantx.js"></script>
    <script>
    $(function() {
        var audioCtx = new AudioContext();
        var songBuffer = null;
        var notes = [];
        var noteBuffers = null;

        function load() {
            var track0 = song.songData[0];
            song.songData = song.songData.slice(1, song.songData.length);

            var songGen = new sonantx.MusicGenerator(song);
            songGen.createAudioBuffer(function(buffer) {
                songBuffer = buffer;
                checkLoaded();
            });

            var soundGen = new sonantx.SoundGenerator(track0);
            notes = [];
            track0.p.forEach(function(pattern) {
                if (pattern == 0) {
                    for (var i = 0; i < 32; i++) {
                        notes.push(0);
                    }
                    return;
                }
                track0.c[pattern - 1].n.forEach(function(note) {
                    notes.push(note);
                });
            });
            var diffNotes = {};
            var diffNotesArray = [];
            notes.forEach(function(note) {
                if (note != 0 && diffNotes[note] === undefined) {
                    diffNotes[note] = true;
                    diffNotesArray.push(note);
                }
            });
            var buffers = {};
            diffNotesArray.forEach(function(note) {
                soundGen.createAudioBuffer(note, 3, function(buffer) {
                    buffers[note] = buffer;
                    var finished = true;
                    diffNotesArray.forEach(function(n) {
                        if (buffers[n] === undefined)
                            finished = false;
                    });
                    if (finished) {
                        noteBuffers = buffers;
                        checkLoaded();
                    }
                });
            });
        }

        load();

        function checkLoaded() {
            if (songBuffer === null || notes === null)
                return;
            isLoaded();
        }

        var startTime;

        function isLoaded() {
            var source = audioCtx.createBufferSource();
            source.buffer = songBuffer;
            source.connect(audioCtx.destination);

            source.start();
            startTime = new Date().getTime();

            $("#loading").text("");

            var currentNote = -1;
            var beatDuration = (song.rowLen / 44100) * 1000;
            var next;
            var validatedNote = false;
            var playNote = function() {
                if (validatedNote) {
                    var buffer = noteBuffers[notes[currentNote]];
                    var source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    source.start();
                }
                validatedNote = false;
                $("#indicator").css("display", "none");

                scheduleNote();
            };
            var scheduleNote = function() {
                var nextNote = -1;
                for (var i = currentNote + 1; i < notes.length; i++) {
                    if (notes[i] !== 0) {
                        nextNote = i;
                        break;
                    }
                }
                if (nextNote === -1)
                    return;
                currentNote = nextNote;
                next = startTime + (currentNote * beatDuration);
                preciseTimeout(playNote, next - new Date().getTime());
                preciseTimeout(function() {
                    $("#indicator").css("display", "inline");
                }, next - new Date().getTime() - (beatDuration));
            }
            scheduleNote();

            function displayTimeout() {
                var now = new Date().getTime();
                $("#time").text(Math.floor(((next - now) / beatDuration) / 4) + 1);
                preciseTimeout(displayTimeout, 10);
            };
            displayTimeout();

            document.addEventListener('keydown', function(event) {
                if (event.keyCode !== 32) // space bar
                    return;
                var now = new Date().getTime();
                if ((next - now) < (beatDuration)) {
                    validatedNote = true;
                }
            });
        }

        function preciseTimeout(callBack, delay) {
            var end = new Date().getTime() + delay;
            var f = function() {
                var now = new Date().getTime();
                if (now < end) {
                    setTimeout(f, end - now);
                } else {
                    callBack();
                }
            };
            f();
        };
    });
    </script>
</head>
<body>
    <p><span id="loading">Loading...</span></p>
    <p><span id="time"></span></p>
    <p><span id="indicator" style="display: none">O</span></p>
</body>
